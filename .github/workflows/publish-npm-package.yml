name: Publish NPM Packages

on:
  release:
    types: [published]

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.8.1'
          registry-url: 'https://registry.npmjs.org'
          always-auth: true
          scope: '@lunnoa-automate'

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Check NPM Authentication
        run: pnpm whoami
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Build Packages
        run: pnpm nx run-many --target=build --projects=apps,toolkit

      - name: Publish toolkit
        run: pnpm nx run toolkit:nx-release-publish --verbose
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NX_VERBOSE_LOGGING: true

      - name: Publish apps
        run: pnpm nx run apps:nx-release-publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NX_VERBOSE_LOGGING: true

      # Add this verification step at the end
      - name: Wait for NPM packages to be available
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "Waiting for NPM packages to be available..."
          timeout=300  # 5 minutes timeout
          interval=10  # Check every 10 seconds

          until curl -s -H "Authorization: Bearer ${{ secrets.NPM_TOKEN }}" "https://registry.npmjs.org/@lunnoa-automate/apps/$VERSION" | grep -q "version" || [ $timeout -le 0 ]; do
            echo "Package @lunnoa-automate/apps@$VERSION not yet available, waiting..."
            sleep $interval
            timeout=$((timeout - interval))
          done

          until curl -s -H "Authorization: Bearer ${{ secrets.NPM_TOKEN }}" "https://registry.npmjs.org/@lunnoa-automate/toolkit/$VERSION" | grep -q "version" || [ $timeout -le 0 ]; do
            echo "Package @lunnoa-automate/toolkit@$VERSION not yet available, waiting..."
            sleep $interval
            timeout=$((timeout - interval))
          done

          if [ $timeout -le 0 ]; then
            echo "Timeout waiting for packages to be available"
            exit 1
          fi

          echo "Packages are available, first workflow complete"
